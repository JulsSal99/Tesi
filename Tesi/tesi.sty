% Tesi Informatica Musicale, basato sul modello di:
% Tesi D.S.I., basato sul modello di:
% Stanford University PhD thesis style, basato sul modello:
% Report style
% Ultima revisione: 30 Novembre 2023
% Revisori: G.Presti; L.A.Ludovico; F. Avanzini; M. Tiraboschi
\ProvidesPackage{tesi}[2023/11/30]

% --- Opzioni -----------------------------------------------------------------
\newif\iftesi@customfont
\tesi@customfonttrue
\newif\iftesi@notminimal
\tesi@notminimaltrue

\DeclareOption{defaultfont}{\tesi@customfontfalse}
\DeclareOption{minimal}{\tesi@notminimalfalse}
\ProcessOptions\relax
% -----------------------------------------------------------------------------

% --- Required Packages -------------------------------------------------------
\PassOptionsToPackage{hidelinks,pdfencoding=unicode}{hyperref}
\PassOptionsToPackage{a-1b,mathxmp}{pdfx}
\PassOptionsToPackage{a4paper}{geometry}

\RequirePackage{geometry}
\RequirePackage{newfile}  % Output to file
\RequirePackage{currfile}  % Get current filename
\RequirePackage{graphicx}
\RequirePackage{etoolbox}
\RequirePackage{iflang}  % language switch
\RequirePackage{fp}  % calculations
\iftesi@notminimal
\PassOptionsToPackage{utf8}{inputenc}
\PassOptionsToPackage{hyperref}{xcolor}

\RequirePackage[utf8]{inputenc}
\RequirePackage{hologo}  % Bibtex logo with \hologo{BibTeX}
\RequirePackage{listings}  % Scrittura di codice
\RequirePackage{url}  % Visualizza e rende interattivi gli URL
\RequirePackage{epsfig}  % Permette immagini in EPS
\RequirePackage{xcolor}  % Gestione avanzata dei colori
\fi

\RequirePackage{pdfx}  % File conforme allo standard PDF-A (obbligatorio per la consegna)
% Keep this last
\RequirePackage{hyperref}
% -----------------------------------------------------------------------------

% --- Font choice -------------------------------------------------------------
\iftesi@customfont
% ACM-like fonts
% https://tex.stackexchange.com/a/540068
\PassOptionsToPackage{T1}{fontenc}
\PassOptionsToPackage{tt=false, type1=true}{libertine}
\PassOptionsToPackage{varqu}{zi4}
\PassOptionsToPackage{libertine}{newtxmath}

\RequirePackage{fontenc}
\RequirePackage{libertine}
\RequirePackage{zi4}
\RequirePackage{newtxmath}
\else
% Simboli matematici default
\RequirePackage{amssymb}
\RequirePackage{amsmath}
\RequirePackage{amsthm}
\fi
% -----------------------------------------------------------------------------

% --- Page format -------------------------------------------------------------
\oddsidemargin 0.5in
\evensidemargin 0in
\marginparwidth 40pt
\marginparsep 10pt
\topmargin 0pt
\headsep .5in
\textheight 8.1in
\textwidth 6in

% Disallow page breaks at hyphens (this will give some underfull vbox's,
% so an alternative is to use \brokenpenalty=100 and manually search
% for and fix such page breaks)
\brokenpenalty=10000

% Baseline-to-baseline skip
\renewcommand{\baselinestretch}{1.0}  % ERA 1.3

% Figures and tables are to be numbered sequentially throughout the
% thesis, rather than within chapters; for style consistency, do
% equations the same.  The following \def of \cl@chapter is a kludge:
% really there should be a \removefromreset, to stop figure numbers, etc.,
% from being reset at chapter beginnings
\def\cl@chapter{\@elt{section}\@elt{footnote}}
\def\thefigure{\@arabic\c@figure}
\def\thetable{\@arabic\c@table}
\def\theequation{\arabic{equation}}

\newif\iffigurespage \newif\iftablespage
\figurespagefalse
\tablespagefalse
% -----------------------------------------------------------------------------

% --- Metadata commands -------------------------------------------------------
% Relatori
\newcommand\makesupervisorlines\relax
\newcommand\supervisor[2][Supervisor]{%
\appto\makesupervisorlines{{\large{}#1:} & #2\\\relax}%
}
\newcommand\relatore[1]{\supervisor[\IfLanguageName{italian}{Relatore}{Supervisor}]{#1}}
\newcommand\correlatore[1]{\supervisor[\IfLanguageName{italian}{Correlatore}{Co-supervisor}]{#1}}

% Università
\newcommand\makeuniversity\relax
\newcommand\theuniversity\relax
\newcommand{\university}[1]{%
\renewcommand\theuniversity{#1}%
\renewcommand\makeuniversity{{\LARGE \uppercase{\theuniversity}\\\relax}}%
}

\newcommand\makeunilogo\relax
\newcommand{\unilogo}[2][height=30mm]{%
\renewcommand\makeunilogo{\centerline{\includegraphics[#1]{#2}}}%
}

\newcommand\makefaculty\relax
\newcommand{\faculty}[1]{\renewcommand\makefaculty{\uppercase{#1}\\}}

\newcommand\makedepartment\relax
\newcommand{\department}[1]{\renewcommand\makedepartment{\uppercase{#1}\\}}

\newcommand\makecdl\relax
\newcommand{\cdl}[1]{\renewcommand\makecdl{\uppercase{#1}}}

% Matricola
\newcommand\makematricola\relax
\newcommand{\matricola}[2][\IfLanguageName{italian}{Matr. Nr.}{Matr. No.}]{\renewcommand\makematricola{#1 #2}}

% Tesi
\newcommand\maketypeofthesis\relax
\newcommand\thetypeofthesis\relax
\newcommand{\typeofthesis}[2][ \IfLanguageName{italian}{di}{by}:]{%
\renewcommand\thetypeofthesis{#2}%
\renewcommand\maketypeofthesis{\thetypeofthesis #1\\\relax}%
}

% Anno
\newcommand\makeacademicyear\relax
\newcommand\academicyears[2]{\renewcommand\makeacademicyear{\sc{}#1 #2}}
\newcommand\academicyear[2][\IfLanguageName{italian}{Anno Accademico}{Academic Year}]{%
\FPeval{\nextyear}{clip(#2+1)}%
\academicyears{#1}{#2-\nextyear}%
}

% Titolo
\title{}

% PDF-A Metadata
\let\Author\relax
\let\Title\relax
\let\Keywords\relax
\let\Subject\relax
\let\Org\relax
\let\Copyright\relax
\let\CopyrightURL\relax
\let\Copyrighted\relax
\let\PublicationType\relax
\let\Journaltitle\relax
\let\Journalnumber\relax
\let\Volume\relax
\let\Issue\relax
\let\Firstpage\relax
\let\Lastpage\relax
\let\Doi\relax
\let\CoverDisplayDate\relax
\let\CoverDate\relax
\let\Title\relax
\let\Author\relax
\let\Copyright\relax
\let\Keywords\relax
\let\Subject\relax

\newcommand\tesixmpbody{%
% Replace the following information with your document's actual
% metadata. If you do not want to set a value for a certain parameter,
% just omit it.
%
% Symbols permitted in metadata
% =============================
% 
% Within the metadata, all printable ASCII characters except
% '\', '{', '}', and '%' represent themselves. Also, all printable
% Unicode characters from the basic multilingual plane (i.e., up to
% code point U+FFFF) can be used directly with the UTF-8 encoding. 
% Consecutive whitespace characters are combined into a single
% space. Whitespace after a macro such as \copyright, \backslash, or
% \sep is ignored. Blank lines are not permitted. Moreover, the
% following markup can be used:
%
%  '\ '         - a literal space  (for example after a macro)                  
%   \%          - a literal '%'                                                 
%   \{          - a literal '{'                                                 
%   \}          - a literal '}'                                                 
%   \backslash  - a literal '\'                                                 
%   \copyright  - the (c) copyright symbol                                      
%
% The macro \sep is only permitted within \Author, \Keywords, and
% \Org.  It is used to separate multiple authors, keywords, etc.
% 
% List of supported metadata fields
% =================================
% 
% Here is a complete list of user-definable metadata fields currently
% supported, and their meanings. More may be added in the future.
% 
% General information:
%
%  \Author           - the document's human author. Separate multiple
%                      authors with \sep.
   \Author{\@author}
%  \Title            - the document's title.
   \Title{\@title}
%  \Keywords         - list of keywords, separated with \sep.
%  \Subject          - the abstract. 
%  \Org              - publishers.
   \Org{Laboratorio di Informatica Musicale, Dipartimento di Informatica ``Giovanni degli Antoni'', Università degli Studi di Milano}
% 
% Copyright information:
%
%  \Copyright        - a copyright statement.
%  \CopyrightURL     - location of a web page describing the owner
%                      and/or rights statement for this document.
%  \Copyrighted      - 'True' if the document is copyrighted, and
%                      'False' if it isn't. This is automatically set
%                      to 'True' if either \Copyright or \CopyrightURL
%                      is specified, but can be overridden. For
%                      example, if the copyright statement is "Public
%                      Domain", this should be set to 'False'.
%
% Publication information:
%
% \PublicationType   - The type of publication. If defined, must be
%                      one of book, catalog, feed, journal, magazine,
%                      manual, newsletter, pamphlet. This is
%                      automatically set to "journal" if \Journaltitle
%                      is specified, but can be overridden.
  \PublicationType{\thetypeofthesis}
% \Journaltitle      - The title of the journal in which the document
%                      was published. 
% \Journalnumber     - The ISSN for the publication in which the
%                      document was published.
% \Volume            - Journal volume.
% \Issue             - Journal issue/number.
% \Firstpage         - First page number of the published version of
%                      the document.
% \Lastpage          - Last page number of the published version of
%                      the document.
% \Doi               - Digital Object Identifier (DOI) for the
%                      document, without the leading "doi:".
% \CoverDisplayDate  - Date on the cover of the journal issue, as a
%                      human-readable text string.
% \CoverDate         - Date on the cover of the journal issue, in a
%                      format suitable for storing in a database field
%                      with a 'date' data type.
}

\newcommand{\metadatitesi}{%
\newoutputstream{tesixmpstream}
\openoutputfile{\currfilebase.xmpdata}{tesixmpstream}
\addtostream{tesixmpstream}{\tesixmpbody}
}
% -----------------------------------------------------------------------------

% --- Page generation ---------------------------------------------------------
% Front page
\newcommand\makefrontpage{
    \metadatitesi\relax%
	\pagestyle{headings}%
	\pagenumbering{gobble}%
	\begin{center}%
		\makeuniversity\relax
		\makefaculty\relax
		\vskip 0.4 cm
		\makedepartment\relax
		\vskip 0.6 cm
		\makeunilogo\relax
		\vskip 0.4 cm
		\makecdl\relax
	\end{center}

	\vskip 0.5 cm
	\vfill

	\begin{center}\Large\uppercase\expandafter{\@title}\end{center}

	\vfill
	\vskip 2cm
	
	\begin{tabular}{ll}\makesupervisorlines\relax\end{tabular}

	\vskip 0.5 cm

	\begin{flushright}\large
		\begin{tabular}{l}
			\maketypeofthesis\relax
			\@author\ifx\@author\empty\else\\\fi
			\makematricola\relax
		\end{tabular}
	\end{flushright}

	\vskip 1 cm

	\begin{center}\makeacademicyear\relax\end{center}
	\newpage
}

% Last page
\newcommand\closingpage[1][%
  \IfLanguageName{italian}{Progetto sviluppato presso il Laboratorio di Informatica Musicale}{Project developed at the Laboratory of Music Informatics (LIM)}
]{
	\newpage
	\pagestyle{plain}
	\pagenumbering{gobble}
	\vspace*{\fill}
	\begin{center}
		\centerline{\includegraphics[height=25mm]{immagini/lim}}
		\vskip 0.4 cm
		\small{#1}
		
		\url{https://www.lim.di.unimi.it}
	\end{center}
}

\def\beforepreface{
	\pagenumbering{gobble}
	\pagestyle{plain}}

\def\prefacesection#1{%
	\chapter*{#1}
	\pagenumbering{roman}
	\addcontentsline{toc}{chapter}{#1}}

\def\afterpreface{%
	\clearpage
	\phantomsection
	\addcontentsline{toc}{chapter}{\contentsname}
	\tableofcontents
	\newpage
	\iftablespage
		{\addvspace{10pt}
		\let\saveaddvspace=\addvspace
		\def\addvspace##1{}
		\phantomsection
		\addcontentsline{toc}{chapter}{%
		  \IfLanguageName{italian}{Elenco delle tabelle}{Table Index}}
		\listoftables
		\let\addvspace=\saveaddvspace}
		\newpage
	\fi
	\iffigurespage
		{\addvspace{10pt}
		\let\saveaddvspace=\addvspace
		\def\addvspace##1{}
		\phantomsection
		\addcontentsline{toc}{chapter}{%
		  \IfLanguageName{italian}{Elenco delle figure}{Figure Index}}
		\listoffigures
		\let\addvspace=\saveaddvspace}
		\newpage
	\fi
	\pagenumbering{arabic}
	\pagestyle{headings}}

\def\beforebibliography{%
	\clearpage\relax%
	\phantomsection\relax%
	\addcontentsline{toc}{chapter}{\bibname}}
% -----------------------------------------------------------------------------
